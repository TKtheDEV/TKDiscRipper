<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Job {{ job.job_id }}</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" type="image/gif" href="/static/favicon.gif">
</head>
<body>
  <header class="header-bar">
    <div class="title-left">
      <a href="/" style="color:white;">‚¨ÖÔ∏è Back</a>
      <h1 style="margin-left: 1rem;">Job Detail</h1>
    </div>
  </header>

  <main class="content">
    <div class="section">
      <h2>üÜî Job Info</h2>
      <strong>ID:</strong> {{ job.job_id }}<br>
      <strong>Type:</strong> {{ job.disc_type }}<br>
      <strong>Label:</strong> {{ job.disc_label }}<br>
      <strong>Status:</strong> <span id="job-status">{{ job.status }}</span><br>
      <strong>Progress:</strong> <span id="job-progress-val">{{ job.progress }}</span>%
    </div>

    <div class="section">
      <h2>üíΩ Paths</h2>
      <strong>Drive:</strong> {{ job.drive }}<br>
      <strong>Temp Folder:</strong> {{ job.temp_folder }}<br>
      <strong>Output Folder:</strong> {{ job.output_folder }}<br>
    </div>

    <div class="section">
      <h2>‚è± Timing</h2>
      <strong>Started:</strong> {{ job.start_time | humantime }}<br>
      <strong>Ended:</strong> {{ job.end_time | humantime if job.end_time else "Still running" }}<br>
      <strong>Duration:</strong> {{ job.elapsed_time | duration }}
    </div>

    <div class="section">
      <h2>üìä Progress</h2>
      <div class="progress-bar total">
        <div class="progress-fill" id="progress-bar" style="width: {{ job.progress }}%;"></div>
      </div>
      <small id="progress-text">{{ job.progress }}%</small>
    </div>

    <div class="section">
      <h2>üìã Live Log</h2>
      <div id="job-log">
        <pre id="log-output" style="white-space: pre-wrap; font-size: 0.9rem;">Connecting...</pre>
      </div>
    </div>
  </main>

  <script>
    const ws = new WebSocket("wss://" + location.host + "/ws/jobs/{{ job.job_id }}/log");

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const logOutput = document.getElementById("log-output");
      if (data.logs) {
        logOutput.textContent += data.logs.join("\n") + "\n";
        logOutput.scrollTop = logOutput.scrollHeight;
      }
    };

    ws.onclose = () => {
      document.getElementById("log-output").textContent += "\nüîå Log stream closed.";
    };

    ws.onerror = (err) => {
      console.error("WebSocket error:", err);
      document.getElementById("log-output").textContent += "\n‚ö†Ô∏è Log stream error.";
    };

    async function updateProgress() {
      const res = await fetch("/jobs/{{ job.job_id }}/json");
      const job = await res.json();

      document.getElementById("job-status").textContent = job.status;
      document.getElementById("job-progress-val").textContent = job.progress;
      document.getElementById("progress-bar").style.width = `${job.progress}%`;
      document.getElementById("progress-text").textContent = `${job.progress}%`;
    }

    setInterval(updateProgress, 2000);
  </script>
</body>
</html>
